<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="Content-Language" content="en-us" />

    <title>Bajar de Peso - Track you daily weight</title>
</head>
<body>
    <div id="container">
        <div id="content" style="width: 80%; float: left;">
            <div>
                <table width="100%" id="data-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Weight (in kgs)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if today %}
                            <tr>
                                <td align="center">{{ today }}</td>
                                <td align="center" class="weight-input"><input type="text" /></td>
                            </tr>
                        {% endif %}
                        {% for entry in data %}
                            <tr>
                                <td align="center">{{ entry.date }}</td>
                                <td align="center" class="weight-input">{{ entry.weight }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div id="placeholder" style="width:600px;height:300px;"></div>
        </div>
        <div id="sidebar" style="width: 20%; float: right;">
            <p><a href="#" id="add_prev_date" style="text-decoration: none;"><img src="/static/images/add.png" style="border: none;" /> Add data for previous date.</a></p>
        </div>
    </div>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js" type="text/javascript"></script>
    <script src="/static/js/jquery.flot.js" type="text/javascript"></script>
    <script type="text/javascript">
        $(document).ready(function() {
            $('.weight-input').dblclick(function() {
                var weight = $(this).html();
                var new_elem = $('<input type="text" />').val(weight).blur(function() { $(this).parent().html(weight); });
                $(this).html(new_elem);
                new_elem.focus();
            });
            $('input').live('keypress', function(e) {
                if(e.keyCode == 13) {
                    var elem = $(this);
                    var date_elem = elem.parent().prev('td');
                    $.post('/', {'date' : date_elem.html(), 'weight' : elem.val()},
                        function(data) {
                            elem.parent().html(data.weight);
                    }, 'json');
                }
            });
            $('#add_prev_date').click(function() {
                if($('input').length != 0) {
                    alert('Please enter data in the focused field before adding new entries');
                    $('input')[0].focus();
                } else {
                    $.get('/get_prev_date/', {}, function(data) {
                        var delete_elem = $('<a></a>').attr('href','#').append($('<img />').attr('src', '/static/images/delete.png').attr('style', 'border: none;')).click(function() { $(this).parent().parent().remove(); return false; });
                        var input_elem = $('<td></td>').attr('align', 'center').append($('<input type="text" />')).append(delete_elem);
                        $('#data-table > tbody:last').append($('<tr></tr>').append($('<td></td>').html(data).attr('align','center')).append(input_elem));
                    });
                }
                return false;
            });

            var options = {
                lines : {show : true},
                points : {show : true},
                //xaxis : {tickDecimals : 0, tickSize : 1}
            }

            var plot_data = [];
            $.get('/get_chart_data/', {}, function(data) {
                plot_data.push(data);
                console.log(plot_data);
                $.plot($('#placeholder'), plot_data, options);
            });
        });
    </script>
</body>
